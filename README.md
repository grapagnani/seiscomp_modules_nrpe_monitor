# Nagios NRPE plugin - monitor SeisComP modules

## Presentation

This Nagios plugin monitors the response time of various
[SeisComP](https://www.seiscomp.de/) modules.

It is based on the status files generated by the SeisComP `scsohlog` module.
Hence only the modules monitored by `scsohlog` can be monitored with this plugin.
SeedLink is not monitored by `scsohlog`.

By default the `scsohlog` module updates its `.seiscomp/log/server.xml` status
files every 60 seconds. Both the output file location and update interval are
configurable inside SeisComP.

We will configure `scsohlog` to call the script `parse_scsohlog_data.py`.
This script will process the `server.xml` file. It will, for each module,
record the value of a given SOH parameter and, upon subsequent calls,
verify that the value of the parameter changed or not. This will be
an indication that the module is working or stalled.

The `parse_scsohlog_data.py` will then create the input file for the NRPE
plugin script `check_seiscomp_module` that will report kind of response time
to Nagios. The response time is actually the delay since the monitored SOH
parameter for a given module last changed.

Your Nagios monitoring server will call this plugin script through NRPE (Nagios
Remote Plugin Executor). All the configuration steps and files provided here
need to be performed/installed on the server running SeisComP, not on the
Nagios monitoring server.

Further below, monitoring server refers to the Nagios monitoring server,
whereas NRPE server refers to the server running SeisComP. Installation
and configuration of the Nagios monitoring server won't be dealt here. Only
installation and configuration of the NRPE server will.

## Installation

### NRPE server software

On debian and ubuntu, this is provided by the package **nagios-nrpe-server**

### Plugin files

* install the script which process the `server.xml` file under, eg:

    `$HOME/bin/parse_scsohlog_data.py`

    with `$HOME` the home directory of the user running SeisComP

* install the NRPE plugin script under:

    `/usr/local/lib/nagios/plugins/check_seiscomp_module`

## Configuration

### SeisComP scsohlog module

Using the SeisComP GUI `scconfig` configurator, or taking
`seiscomp/etc/defaults/scsohlog.cfg` as example, you need
to give `scsohlog` the path to the `parse_scsohlog_data.py` script.

The end result will be this entry created inside the file
`seiscomp/etc/scsohlog.cfg`:

```
# Defines an output script which is called after the output
# file is generated to trigger file processing. The execution
# of the script is blocking the application and thus the
# script should not spend too much time with its operations.
monitor.output.script = "<fullpath_to_user_directory>/bin/parse_scsohlog_data.py"
```

### Configuration of the plugin files

* The script `parse_scsohlog_data.py` needs to know the path to the `server.xml`
file. Set the variable `SCSOHLOG_XMLFILE` accordingly when necessary.

* The script `parse_scsohlog_data.py` uses a file to record the values of the
modules SOH parameters. It is defined through the variable `STATE_RECORD_FILE`.

* The script `parse_scsohlog_data.py` creates a file used by the NRPE plugin
script `check_seiscomp_module`. Both scripts need to know the path to this
file, which is set through the variable `MODULE_RESPONSE_FILE `. It might be
wrong to have this file stored under `/tmp/` directory. With recent versions
of Systemd, the NRPE server has not access to the system wide `/tmp/` directory.
Instead, Systemd is configured to create a dedicated `/tmp/` directory for
the sole usage of the NRPE server.

* The plugin script `check_seiscomp_module` defines two thresholds. When
the delay since the last change of the value of a module's monitored SOH
parameter reaches either the WARNING or CRITICAL threshold, the plugin script
will report resepectively a WARNING or CRITICAL state for that module.
The thresholds are defined through the variables below, by default to 4 minutes
and 8 minutes:

    * `WARNING_THRESHOLD`: response time threshold, in seconds, above which a WARNING state is reported
    * `CRITICAL_THRESHOLD`: response time threshold, in seconds, above which a CRITICAL state is reported

### NRPE

* The NRPE server main configufation file, `/etc/nagios/nrpe.cfg` on debian, needs to:

    * allow connection from the IP of your Nagios monitoring server:

    `allowed_hosts=127.0.0.1, <ip_of_your_monitoring_server>`

    * allow the monitoring server to pass arguments:

    `dont_blame_nrpe=1`

    * define the command that the client needs to execute:

    `command[check_seiscomp_module]=/usr/local/lib/nagios/plugins/check_seiscomp_module $ARG1$`

* Finally restart the NRPE server

## Testing

On debian and ubuntu, the package **nagios-nrpe-plugin** provides the
command `/usr/lib/nagios/plugins/check_nrpe`.

You can use the command this way:

`/usr/lib/nagios/plugins/check_nrpe -H my_seiscomp_server_IP -c check_seiscomp_module -a my_module_name`

with:
* `my_seiscomp_server_IP`: the IP of your NRPE server (i.e. your SeisComP server)
* `my_module_name`: the name of whatever running module (e.g. scmag, scautopick, ...)

If you encounter a *Socket timeout* error when running `check_nrpe` command,
you can try adding the option `-n`.

### Example of output

```
$ /usr/lib/nagios/plugins/check_nrpe -nH my_seiscomp_server_ip -c check_seiscomp_module -a scmag
OK: 1 min 52 sec since last response

$ /usr/lib/nagios/plugins/check_nrpe -nH my_seiscomp_server_ip -c check_seiscomp_module -a scvoice
WARNING: 6 min 11 sec since last response

$ /usr/lib/nagios/plugins/check_nrpe -nH my_seiscomp_server_ip -c check_seiscomp_module -a scautoloc
CRITICAL: 11 min 9 sec since last response
```
